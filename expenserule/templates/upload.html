{% extends "base.html" %}

{% block title %}Upload Receipt &mdash; ExpenseRule{% endblock %}

{% block content %}
<div class="page-header">
  <hgroup>
    <h2>Upload Receipt</h2>
    <p>JPEG, PNG, or PDF &mdash; fields are extracted automatically for your review</p>
  </hgroup>
</div>

<div class="upload-layout">

  <!-- Left: file upload zone -->
  <div>
    <div class="upload-zone">
      <span class="upload-icon">&#x1F9FE;</span>
      <form id="upload-form" enctype="multipart/form-data">
        <label for="file">
          Select receipt file
          <input type="file" id="file" name="file" accept=".jpg,.jpeg,.png,.pdf" required />
          <small>JPEG &bull; PNG &bull; PDF &bull; max 20&thinsp;MB</small>
        </label>
        <button type="submit" id="upload-btn">Extract Fields</button>
      </form>
    </div>

    <div id="upload-status" class="upload-status" aria-live="polite"></div>
  </div>

  <!-- Right: review card (hidden until extraction succeeds) -->
  <div id="review-panel" style="display: none;">
    <div class="review-card">
      <div class="review-card-header">
        <h3>Review Extracted Fields</h3>
        <span id="source-badge" class="source-badge"></span>
      </div>

      <form id="review-form" method="post" action="/expenses" class="review-card-body">
        <input type="hidden" id="upload_id" name="upload_id" />

        <label for="merchant">
          Merchant
          <input type="text" id="merchant" name="merchant" required autocomplete="off" />
        </label>

        <div class="grid">
          <label for="date">
            Date
            <input type="date" id="date" name="date" required />
          </label>
          <label for="amount">
            Amount ($)
            <input type="number" id="amount" name="amount" step="0.01" min="0.01" required />
          </label>
        </div>

        <label for="category">
          Category
          <select id="category" name="category" required>
            {% for cat in categories %}
            <option value="{{ cat.name }}">{{ cat.name }} &mdash; Line {{ cat.line }}</option>
            {% endfor %}
          </select>
        </label>

        <label for="notes">
          Notes <small class="text-muted">(optional)</small>
          <input type="text" id="notes" name="notes" maxlength="500" placeholder="Any additional notes&hellip;" />
        </label>

        <div class="review-actions">
          <button type="submit">Save Expense</button>
          <button type="button" class="secondary outline" onclick="resetUpload()">Start Over</button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
  const uploadForm   = document.getElementById('upload-form');
  const reviewPanel  = document.getElementById('review-panel');
  const statusDiv    = document.getElementById('upload-status');
  const uploadBtn    = document.getElementById('upload-btn');
  const sourceBadge  = document.getElementById('source-badge');
  const categoryEl   = document.getElementById('category');

  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('file');
    if (!fileInput.files.length) return;

    uploadBtn.disabled = true;
    uploadBtn.setAttribute('aria-busy', 'true');
    statusDiv.innerHTML = '<span class="text-muted">Uploading and extracting&hellip;</span>';
    reviewPanel.style.display = 'none';

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
      const resp = await fetch('/upload/parse', { method: 'POST', body: formData });
      const data = await resp.json();

      if (!resp.ok) {
        statusDiv.innerHTML = `<span class="status-err">Error: ${data.detail || 'Upload failed.'}</span>`;
        return;
      }

      // Populate review form
      document.getElementById('upload_id').value = data.upload_id || '';
      document.getElementById('merchant').value  = data.merchant  || '';
      document.getElementById('date').value      = data.date      || '';
      document.getElementById('amount').value    = data.amount != null ? data.amount : '';

      // Pre-select the suggested category
      if (data.category) {
        for (const opt of categoryEl.options) {
          if (opt.value === data.category) {
            opt.selected = true;
            break;
          }
        }
      }

      // Show source badge
      const src = data.category_source || '';
      const srcLabels = {
        'correction_memory': { label: 'remembered', cls: 'src-correction' },
        'lookup':            { label: 'lookup',      cls: 'src-lookup'     },
        'llm':               { label: 'AI suggest',  cls: 'src-llm'        },
      };
      const srcInfo = srcLabels[src] || { label: src, cls: '' };
      sourceBadge.textContent = srcInfo.label;
      sourceBadge.className   = 'source-badge ' + srcInfo.cls;

      statusDiv.innerHTML = '<span class="status-ok">&#x2713; Extraction complete &mdash; review and save</span>';
      reviewPanel.style.display = 'block';

    } catch (err) {
      statusDiv.innerHTML = `<span class="status-err">Network error: ${err.message}</span>`;
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.removeAttribute('aria-busy');
    }
  });

  function resetUpload() {
    uploadForm.reset();
    reviewPanel.style.display = 'none';
    statusDiv.innerHTML = '';
    sourceBadge.textContent = '';
    sourceBadge.className = 'source-badge';
  }
</script>
{% endblock %}
